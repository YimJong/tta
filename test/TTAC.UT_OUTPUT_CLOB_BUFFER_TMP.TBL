DROP TABLE TTAC.UT_OUTPUT_CLOB_BUFFER_TMP CASCADE CONSTRAINTS;

CREATE TABLE TTAC.UT_OUTPUT_CLOB_BUFFER_TMP
(
  OUTPUT_ID    RAW(32)                          NOT NULL,
  MESSAGE_ID   NUMBER(38)                       NOT NULL,
  TEXT         CLOB,
  ITEM_TYPE    VARCHAR2(1000 BYTE),
  IS_FINISHED  NUMBER(1)                        DEFAULT 0                     NOT NULL
)
LOB (TEXT) STORE AS SECUREFILE UT_OUTPUT_TEXT (
  TABLESPACE  USERS
  ENABLE      STORAGE IN ROW
  CHUNK       8192
  RETENTION   NONE
  NOCACHE
  LOGGING)
TABLESPACE USERS
PCTFREE    10
INITRANS   100
MAXTRANS   255
STORAGE    (
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           )
NOLOGGING 
NOCOMPRESS 
NOCACHE;


CREATE UNIQUE INDEX TTAC.UT_OUTPUT_CLOB_BUFFER_TMP_PK ON TTAC.UT_OUTPUT_CLOB_BUFFER_TMP
(OUTPUT_ID, MESSAGE_ID)
NOLOGGING
TABLESPACE USERS
PCTFREE    10
INITRANS   2
MAXTRANS   255
STORAGE    (
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           );

ALTER INDEX TTAC.UT_OUTPUT_CLOB_BUFFER_TMP_PK
  MONITORING USAGE;

ALTER TABLE TTAC.UT_OUTPUT_CLOB_BUFFER_TMP ADD (
  CONSTRAINT UT_OUTPUT_CLOB_BUFFER_TMP_CK
  CHECK (
         is_finished = 0 and (text is not null or item_type is not null )
      or is_finished = 1 and text is null and item_type is null )
  ENABLE VALIDATE
,  CONSTRAINT UT_OUTPUT_CLOB_BUFFER_TMP_PK
  PRIMARY KEY
  (OUTPUT_ID, MESSAGE_ID)
  USING INDEX TTAC.UT_OUTPUT_CLOB_BUFFER_TMP_PK
  ENABLE VALIDATE);


ALTER TABLE TTAC.UT_OUTPUT_CLOB_BUFFER_TMP ADD (
  CONSTRAINT UT_OUTPUT_CLOB_BUFFER_TMP_FK 
  FOREIGN KEY (OUTPUT_ID) 
  REFERENCES TTAC.UT_OUTPUT_BUFFER_INFO_TMP (OUTPUT_ID)
  ON DELETE CASCADE
  ENABLE VALIDATE);
